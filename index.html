<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Monitoring AMT - Elnusa Petrofin</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Stable Versions) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Recharts Dependencies (Critical for UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/classnames@2.3.2/index.js"></script>
    
    <!-- 4. Recharts Library (Using v2.5.0 which has stable UMD support) -->
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    
    <!-- 5. Babel (Compiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 6. SweetAlert2 (New) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
      
      /* Custom Animations */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      
      @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
      .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

      @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      .animate-scale-up { animation: scaleUp 0.3s ease-out; }
      
      /* Custom Scrollbar for tables */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
      
      /* SweetAlert Custom Font */
      .swal2-popup { font-family: 'Inter', sans-serif !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.3"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel">
        /** 
         * GLOBAL INIT
         */
        const { useState, useEffect, useMemo } = React;
        
        // Safety check for Recharts
        const RechartsObj = window.Recharts || {};
        const { 
            BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, 
            PieChart, Pie, Cell, Legend, CartesianGrid, AreaChart, Area 
        } = RechartsObj;

        // --- 1. CONSTANTS & DATA STRUCTURES ---
        
        const PunishmentLevel = {
            NONE: 'None',
            BAP_COACHING: 'BAP/Coaching',
            SURAT_TEGURAN: 'Surat Teguran', // 1 month
            SP1: 'SP 1', // 3 months
            SP2: 'SP 2', // 6 months
            SP3: 'SP 3', // Final
            PHK: 'PHK' // Termination
        };

        const PUNISHMENT_DURATION_DAYS = {
            [PunishmentLevel.NONE]: 0,
            [PunishmentLevel.BAP_COACHING]: 30, 
            [PunishmentLevel.SURAT_TEGURAN]: 30,
            [PunishmentLevel.SP1]: 90,
            [PunishmentLevel.SP2]: 180,
            [PunishmentLevel.SP3]: 0, 
            [PunishmentLevel.PHK]: 0 
        };

        const INITIAL_LOCATIONS = [
            "FT Krueng Raya", "FT Lhokseumawe", "FT Medan Group", "FT Sibolga", "FT Gunung Sitoli",
            "IT Teluk Kabung", "FT Sei Siak", "IT Dumai", "FT Indragiri Hilir", "IT Kertapati",
            "FT Jambi", "FT Pulau Baai", "FT Pangkal Balam", "FT Tanjung Pandan", "IT Panjang",
            "IT Manggis", "FT Sanggaran", "IT Ampenan", "FT Badas", "FT Bima", "FT Waingapu",
            "FT Tenau", "FT Maumere", "FT Ende", "FT Reo", "Depo Semper", "FT Atapupu",
            "PTPL Surabaya", "IT Pontianak", "IT Balikpapan", "FT Samarinda", "IT Banjarmasin",
            "Jobber Berau (Pengawas Utama)", "IT Makassar", "FT Parepare", "FT Palopo",
            "FT Donggala", "FT Gorontalo", "FT Moutong", "IT Bitung", "FT Kendari", "FT Baubau",
            "FT Pulau Raha", "FT Poso", "FT Kolonodale", "FT Tolitoli", "FT Kolaka", "FT Tahuna",
            "FT Banggai", "FT Luwuk", "FT Wayame", "FT Namlea", "FT Masohi", "FT Tobelo",
            "FT Jayapura", "FT Timika", "IT AVIASI SUMBAGSEL"
        ];

        const INITIAL_VIOLATIONS = [
            "Overspeed", "Rotasi AMT", "Blackzone", "Tidak Koperatif", "Merokok",
            "Phone Detection", "Seatbelt Detection", "Merubah Arah Kamera",
            "Menutup Kamera Depan (DSM)", "Fraud", "Fraud Ownuse", "Laka Lantas"
        ];

        // --- 2. DATABASE SERVICE (Local Storage Mock) ---
        const STORAGE_KEYS = {
            AMTS: 'amt_app_amts',
            CASES: 'amt_app_cases',
            VIOLATIONS: 'amt_app_violations',
            LOCATIONS: 'amt_app_locations'
        };

        class MockDatabase {
            constructor() {
                this.init();
            }

            init() {
                if (!localStorage.getItem(STORAGE_KEYS.LOCATIONS)) {
                    const locs = INITIAL_LOCATIONS.map((name, idx) => ({ id: `loc_${idx}`, name }));
                    localStorage.setItem(STORAGE_KEYS.LOCATIONS, JSON.stringify(locs));
                }
                if (!localStorage.getItem(STORAGE_KEYS.VIOLATIONS)) {
                    const vios = INITIAL_VIOLATIONS.map((name, idx) => ({ id: `vio_${idx}`, name }));
                    localStorage.setItem(STORAGE_KEYS.VIOLATIONS, JSON.stringify(vios));
                }
                
                // Seed Initial Data if Empty
                const currentAmts = JSON.parse(localStorage.getItem(STORAGE_KEYS.AMTS) || '[]');
                if (currentAmts.length === 0) {
                   this.seedInitialData();
                }
            }

            seedInitialData() {
                console.log("Seeding Database...");
                const locs = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOCATIONS) || '[]');
                const vios = JSON.parse(localStorage.getItem(STORAGE_KEYS.VIOLATIONS) || '[]');
                const rnd = (arr) => arr[Math.floor(Math.random() * arr.length)];
                
                const dummyNames = [
                    "Budi Santoso", "Agus Pratama", "Dedi Kurniawan", "Eko Prasetyo", "Fajar Nugroho",
                    "Guntur Wibowo", "Heri Susanto", "Iwan Setiawan", "Joko Widodo", "Kurniawan Dwi",
                    "Lukman Hakim", "Muhammad Rizky", "Nanang Suherman", "Oki Saputra", "Pandu Wijaya",
                    "Rian Hidayat", "Slamet Riyadi", "Tono Sutono", "Wahyu Illahi", "Zainal Abidin"
                ];

                const generatedAMTs = dummyNames.map((name, idx) => ({
                    id: `amt_seed_${idx}`,
                    name: name,
                    role: Math.random() > 0.5 ? 'AMT 1' : 'AMT 2',
                    locationId: rnd(locs).id
                }));
                localStorage.setItem(STORAGE_KEYS.AMTS, JSON.stringify(generatedAMTs));

                const cases = [];
                // Generate Active Blocks
                for(let i=0; i<5; i++) {
                    const amt = generatedAMTs[i];
                    const vio = rnd(vios);
                    const loc = locs.find(l => l.id === amt.locationId);
                    cases.push({
                        id: `case_blk_${i}`,
                        amtId: amt.id,
                        amtName: amt.name,
                        amtRole: amt.role,
                        amtLocation: loc ? loc.name : 'Unknown',
                        violationTypeId: vio.id,
                        violationName: vio.name,
                        status: 'BLOCKED',
                        blockDate: new Date(Date.now() - Math.floor(Math.random() * 5) * 86400000).toISOString().split('T')[0],
                    });
                }
                // Generate History
                for(let i=5; i<15; i++) {
                    const amt = generatedAMTs[i];
                    const vio = rnd(vios);
                    const loc = locs.find(l => l.id === amt.locationId);
                    const levels = [PunishmentLevel.BAP_COACHING, PunishmentLevel.SURAT_TEGURAN, PunishmentLevel.SP1, PunishmentLevel.SP2, PunishmentLevel.SP3];
                    const level = rnd(levels);
                    const blockDaysAgo = Math.floor(Math.random() * 30) + 10;
                    const unblockDaysAgo = blockDaysAgo - 2;
                    const blockDate = new Date(Date.now() - blockDaysAgo * 86400000);
                    const unblockDate = new Date(Date.now() - unblockDaysAgo * 86400000);
                    const endDate = new Date(unblockDate);
                    endDate.setDate(endDate.getDate() + PUNISHMENT_DURATION_DAYS[level]);

                    cases.push({
                        id: `case_hist_${i}`,
                        amtId: amt.id,
                        amtName: amt.name,
                        amtRole: amt.role,
                        amtLocation: loc ? loc.name : 'Unknown',
                        violationTypeId: vio.id,
                        violationName: vio.name,
                        status: 'UNBLOCKED',
                        blockDate: blockDate.toISOString().split('T')[0],
                        unblockDate: unblockDate.toISOString().split('T')[0],
                        bapDate: unblockDate.toISOString().split('T')[0],
                        punishmentLevel: level,
                        punishmentEndDate: endDate.toISOString().split('T')[0],
                        notes: "Auto-generated history."
                    });
                }
                localStorage.setItem(STORAGE_KEYS.CASES, JSON.stringify(cases));
            }

            getLocations() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.LOCATIONS) || '[]'); }
            getViolations() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.VIOLATIONS) || '[]'); }
            getAMTs() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.AMTS) || '[]'); }
            getCases() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.CASES) || '[]'); }

            addAMT(name, role, locationId) {
                const amts = this.getAMTs();
                const newAMT = { id: `amt_${Date.now()}`, name, role, locationId };
                amts.push(newAMT);
                localStorage.setItem(STORAGE_KEYS.AMTS, JSON.stringify(amts));
                return newAMT;
            }

            addViolationType(name) {
                const vios = this.getViolations();
                const newVio = { id: `vio_${Date.now()}`, name, isCustom: true };
                vios.push(newVio);
                localStorage.setItem(STORAGE_KEYS.VIOLATIONS, JSON.stringify(vios));
            }
            
            deleteViolationType(id) {
                const vios = this.getViolations().filter(v => v.id !== id);
                localStorage.setItem(STORAGE_KEYS.VIOLATIONS, JSON.stringify(vios));
            }

            createBlockCase(amtId, violationTypeId, blockDate) {
                const amts = this.getAMTs();
                const vios = this.getViolations();
                const locs = this.getLocations();
                const amt = amts.find(a => a.id === amtId);
                const vio = vios.find(v => v.id === violationTypeId);
                const loc = locs.find(l => l.id === amt?.locationId);

                const newCase = {
                    id: `case_${Date.now()}`,
                    amtId,
                    amtName: amt.name,
                    amtRole: amt.role,
                    amtLocation: loc ? loc.name : 'Unknown',
                    violationTypeId,
                    violationName: vio.name,
                    status: 'BLOCKED',
                    blockDate,
                };
                const cases = this.getCases();
                cases.push(newCase);
                localStorage.setItem(STORAGE_KEYS.CASES, JSON.stringify(cases));
                return newCase;
            }

            processUnblock(caseId, unblockDate, punishmentLevel, notes) {
                const cases = this.getCases();
                const idx = cases.findIndex(c => c.id === caseId);
                if (idx === -1) return;

                const duration = PUNISHMENT_DURATION_DAYS[punishmentLevel];
                const endDate = new Date(unblockDate);
                endDate.setDate(endDate.getDate() + duration);

                cases[idx] = {
                    ...cases[idx],
                    status: 'UNBLOCKED',
                    unblockDate,
                    bapDate: unblockDate,
                    punishmentLevel,
                    punishmentEndDate: punishmentLevel === PunishmentLevel.PHK ? 'Permanent' : endDate.toISOString().split('T')[0],
                    notes
                };
                localStorage.setItem(STORAGE_KEYS.CASES, JSON.stringify(cases));
            }

            updateCase(caseId, updates) {
                const cases = this.getCases();
                const idx = cases.findIndex(c => c.id === caseId);
                if (idx === -1) return;
                
                cases[idx] = { ...cases[idx], ...updates };
                localStorage.setItem(STORAGE_KEYS.CASES, JSON.stringify(cases));
            }

            getActivePunishment(amtId) {
                const cases = this.getCases().filter(c => c.amtId === amtId && c.status === 'UNBLOCKED');
                if (cases.length === 0) return null;
                cases.sort((a, b) => new Date(b.unblockDate).getTime() - new Date(a.unblockDate).getTime());
                const lastCase = cases[0];
                if (lastCase.punishmentLevel === PunishmentLevel.PHK) return { level: PunishmentLevel.PHK, endDate: 'Permanent' };
                const endDate = lastCase.punishmentEndDate ? new Date(lastCase.punishmentEndDate) : new Date(0);
                const today = new Date();
                if (endDate >= today) return { level: lastCase.punishmentLevel, endDate: lastCase.punishmentEndDate };
                return null;
            }

            suggestPunishment(amtId) {
                const active = this.getActivePunishment(amtId);
                if (!active) return PunishmentLevel.BAP_COACHING;
                switch(active.level) {
                    case PunishmentLevel.BAP_COACHING: return PunishmentLevel.SURAT_TEGURAN;
                    case PunishmentLevel.SURAT_TEGURAN: return PunishmentLevel.SP1;
                    case PunishmentLevel.SP1: return PunishmentLevel.SP2;
                    case PunishmentLevel.SP2: return PunishmentLevel.SP3;
                    case PunishmentLevel.SP3: return PunishmentLevel.PHK;
                    default: return PunishmentLevel.BAP_COACHING;
                }
            }
        }
        const db = new MockDatabase();


        // --- 3. COMPONENTS ---

        // Helper: Format Date
        const formatDate = (dateStr) => {
            if(!dateStr || dateStr === 'Permanent') return dateStr;
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateStr).toLocaleDateString('id-ID', options);
        };

        // Component: StatsCharts
        const StatsCharts = ({ cases }) => {
            if (!BarChart || !PieChart || !AreaChart) {
                return (
                    <div className="bg-red-50 border border-red-200 p-4 rounded-lg flex items-center justify-center text-red-600 font-bold">
                        Error: Recharts library failed to load.
                    </div>
                );
            }

            const COLORS = ['#1e40af', '#dc2626', '#10b981', '#f59e0b', '#6366f1', '#8b5cf6', '#ec4899'];
            
            // Data Prep
            const violationCounts = {};
            cases.forEach(c => { violationCounts[c.violationName] = (violationCounts[c.violationName] || 0) + 1; });
            const violationData = Object.keys(violationCounts).map(name => ({ name, value: violationCounts[name] })).sort((a, b) => b.value - a.value);

            const locationCounts = {};
            cases.forEach(c => { locationCounts[c.amtLocation] = (locationCounts[c.amtLocation] || 0) + 1; });
            const locationData = Object.keys(locationCounts).map(name => ({ name, count: locationCounts[name] })).sort((a, b) => b.count - a.count).slice(0, 10);

            const trendMap = {};
            cases.forEach(c => {
                const d = new Date(c.blockDate);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                trendMap[key] = (trendMap[key] || 0) + 1;
            });
            const trendData = Object.keys(trendMap).sort().map(key => {
                const [year, month] = key.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1);
                return { name: date.toLocaleString('id-ID', { month: 'long', year: 'numeric' }), count: trendMap[key] };
            });

            return (
                <div className="space-y-6 mb-8 animate-fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-md border border-slate-100 relative overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center">
                                <span className="w-2 h-2 rounded-full bg-red-600 mr-2"></span>Trend Pemblokiran (Bulanan)
                            </h3>
                        </div>
                        <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={trendData}>
                                    <defs>
                                        <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#dc2626" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#dc2626" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 12}} />
                                    <YAxis axisLine={false} tickLine={false} tick={{fontSize: 12}} />
                                    <Tooltip contentStyle={{ borderRadius: '8px', border: 'none' }} />
                                    <Area type="monotone" dataKey="count" stroke="#dc2626" strokeWidth={2} fillOpacity={1} fill="url(#colorCount)" />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center">
                                <span className="w-2 h-2 rounded-full bg-blue-700 mr-2"></span>Distribusi Pelanggaran
                            </h3>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={violationData} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={5} dataKey="value">
                                            {violationData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                        </Pie>
                                        <Tooltip />
                                        <Legend layout="vertical" verticalAlign="middle" align="right" wrapperStyle={{fontSize: '11px'}} />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center">
                                <span className="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>Lokasi Terbanyak
                            </h3>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={locationData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={110} style={{fontSize: '11px'}} />
                                        <Tooltip />
                                        <Bar dataKey="count" fill="#10b981" radius={[0, 4, 4, 0]} barSize={24} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Component: ViewMode
        const ViewMode = () => {
            const [cases, setCases] = useState([]);
            const [locations, setLocations] = useState([]);
            
            // Filter States
            const [filterLocation, setFilterLocation] = useState('');
            const [filterName, setFilterName] = useState('');
            const [filterRole, setFilterRole] = useState('');
            const [filterStatus, setFilterStatus] = useState('');

            useEffect(() => {
                setLocations(db.getLocations());
                const loadData = () => {
                    const allCases = db.getCases();
                    allCases.sort((a, b) => {
                        if (a.status === 'BLOCKED' && b.status !== 'BLOCKED') return -1;
                        if (a.status !== 'BLOCKED' && b.status === 'BLOCKED') return 1;
                        return new Date(b.blockDate).getTime() - new Date(a.blockDate).getTime();
                    });
                    setCases(allCases);
                };
                loadData();
                const interval = setInterval(loadData, 2000);
                return () => clearInterval(interval);
            }, []);

            const blockedCount = cases.filter(c => c.status === 'BLOCKED').length;
            const unblockedCount = cases.filter(c => c.status === 'UNBLOCKED').length;
            const phkCount = cases.filter(c => c.punishmentLevel === 'PHK').length;

            // --- FILTER LOGIC ---
            const filteredCases = cases.filter(c => {
                // Flexible Location Search (Type or List)
                const matchLoc = filterLocation === '' || c.amtLocation.toLowerCase().includes(filterLocation.toLowerCase());
                
                // Name Filter (Standard Text Input)
                const matchName = filterName === '' || c.amtName.toLowerCase().includes(filterName.toLowerCase());
                
                const matchRole = filterRole === '' || c.amtRole === filterRole;
                const matchStatus = filterStatus === '' || c.status === filterStatus;
                return matchLoc && matchName && matchRole && matchStatus;
            });

            const resetFilters = () => {
                setFilterLocation('');
                setFilterName('');
                setFilterRole('');
                setFilterStatus('');
            };

            const handleExportCSV = () => {
                if (filteredCases.length === 0) { 
                    Swal.fire({ icon: 'warning', title: 'Perhatian', text: "Tidak ada data untuk diekspor sesuai filter saat ini." }); 
                    return; 
                }
                const headers = ["No", "Nama AMT", "Jabatan", "Lokasi", "Jenis Pelanggaran", "Status", "Tanggal Blokir", "Tanggal Unblock", "Level Punishment", "Tanggal Berakhir Sanksi"];
                const csvRows = [
                    headers.join(","),
                    ...filteredCases.map((c, index) => {
                        const safe = (str) => `"${(str || "").replace(/"/g, '""')}"`;
                        return [
                            index + 1, safe(c.amtName), safe(c.amtRole), safe(c.amtLocation), safe(c.violationName),
                            safe(c.status), safe(c.blockDate), safe(c.unblockDate || "-"), safe(c.punishmentLevel || "-"), safe(c.punishmentEndDate || "-")
                        ].join(",");
                    })
                ];
                const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Public_View_AMT_${new Date().toISOString().slice(0, 19)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="p-6 max-w-[1600px] mx-auto space-y-8 animate-fade-in">
                    {/* Header... (Same as before) */}
                    <div className="flex flex-col md:flex-row justify-between items-end md:items-center pb-6 border-b border-slate-200">
                        <div>
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">Dashboard Monitoring</h1>
                            <p className="text-slate-500 mt-1">Pemantauan Real-time Pelanggaran & Sanksi.</p>
                        </div>
                        <div className="bg-blue-50 text-blue-800 px-4 py-2 rounded-lg text-sm font-semibold border border-blue-100">
                            Last Update: {new Date().toLocaleTimeString()}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-xl shadow border-l-4 border-red-600 p-6">
                            <div className="text-slate-500 text-sm font-bold uppercase">AMT Terblokir</div>
                            <div className="text-4xl font-black text-slate-800">{blockedCount}</div>
                        </div>
                        <div className="bg-white rounded-xl shadow border-l-4 border-emerald-500 p-6">
                            <div className="text-slate-500 text-sm font-bold uppercase">Aktif / Unblocked</div>
                            <div className="text-4xl font-black text-slate-800">{unblockedCount}</div>
                        </div>
                        <div className="bg-white rounded-xl shadow border-l-4 border-slate-700 p-6">
                            <div className="text-slate-500 text-sm font-bold uppercase">Total PHK</div>
                            <div className="text-4xl font-black text-slate-800">{phkCount}</div>
                        </div>
                    </div>

                    <StatsCharts cases={cases} />

                    <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                        <div className="p-5 border-b border-slate-200 bg-slate-50">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                                <h2 className="font-bold text-slate-800 text-lg">Riwayat Kasus</h2>
                                <button onClick={handleExportCSV} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm text-sm">
                                    Export Data
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                                {/* FLEXIBLE LOCATION SEARCH (Input + Datalist) */}
                                <div className="flex flex-col gap-1.5 relative">
                                    <input 
                                        list="viewLocationOptions" 
                                        type="text" 
                                        placeholder="Cari Lokasi / Pilih List..." 
                                        value={filterLocation} 
                                        onChange={(e) => setFilterLocation(e.target.value)} 
                                        className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500 placeholder-slate-400" 
                                    />
                                    <datalist id="viewLocationOptions">
                                        {locations.map(l => <option key={l.id} value={l.name} />)}
                                    </datalist>
                                </div>
                                
                                {/* NAME FILTER */}
                                <input 
                                    type="text" 
                                    placeholder="Cari Nama..." 
                                    value={filterName} 
                                    onChange={(e) => setFilterName(e.target.value)} 
                                    className="w-full border p-2.5 rounded-lg text-sm" 
                                />

                                <select value={filterRole} onChange={(e) => setFilterRole(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm">
                                    <option value="">Semua Jabatan</option>
                                    <option value="AMT 1">AMT 1</option>
                                    <option value="AMT 2">AMT 2</option>
                                </select>
                                <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm">
                                    <option value="">Semua Status</option>
                                    <option value="BLOCKED">Blocked</option>
                                    <option value="UNBLOCKED">Unblocked</option>
                                </select>
                                <button onClick={resetFilters} className="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2.5 rounded-lg text-sm">Reset</button>
                            </div>
                        </div>
                        {/* Table... (Same as before) */}
                        <div className="overflow-x-auto max-h-[600px]">
                            <table className="w-full text-left text-sm text-slate-600">
                                <thead className="bg-blue-900 text-white uppercase text-xs sticky top-0">
                                    <tr>
                                        <th className="px-6 py-4">Nama AMT</th>
                                        <th className="px-6 py-4">Jabatan</th>
                                        <th className="px-6 py-4">Lokasi</th>
                                        <th className="px-6 py-4">Jenis Pelanggaran</th>
                                        <th className="px-6 py-4">Status</th>
                                        <th className="px-6 py-4">Punishment</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredCases.map((c, idx) => (
                                        <tr key={c.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}>
                                            <td className="px-6 py-4 font-bold text-slate-800">{c.amtName}</td>
                                            <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold ${c.amtRole === 'AMT 1' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{c.amtRole}</span></td>
                                            <td className="px-6 py-4">{c.amtLocation}</td>
                                            <td className="px-6 py-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">{c.violationName}</span></td>
                                            <td className="px-6 py-4"><span className={`px-2 py-1 rounded-full text-xs font-bold ${c.status === 'BLOCKED' ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`}>{c.status}</span></td>
                                            <td className="px-6 py-4">
                                                {c.status === 'UNBLOCKED' ? (
                                                    <div className="flex flex-col">
                                                        <span className="font-bold text-blue-700">{c.punishmentLevel}</span>
                                                        <span className="text-xs text-slate-500 mt-1">Ends: {formatDate(c.punishmentEndDate)}</span>
                                                    </div>
                                                ) : <span className="text-slate-400 italic text-xs">Menunggu Proses</span>}
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredCases.length === 0 && <tr><td colSpan={6} className="text-center py-10 text-slate-400">Tidak ada data ditemukan</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // Component: AdminPanel
        const AdminPanel = () => {
            const [tab, setTab] = useState('DASHBOARD');
            const [locations, setLocations] = useState([]);
            const [violations, setViolations] = useState([]);
            const [amts, setAmts] = useState([]);
            const [cases, setCases] = useState([]);

            const [newAmtName, setNewAmtName] = useState('');
            const [newAmtRole, setNewAmtRole] = useState('AMT 1');
            const [selectedLoc, setSelectedLoc] = useState('');
            const [selectedVio, setSelectedVio] = useState('');
            const [blockDate, setBlockDate] = useState(new Date().toISOString().split('T')[0]);

            const [selectedCase, setSelectedCase] = useState(null);
            const [unblockDate, setUnblockDate] = useState(new Date().toISOString().split('T')[0]);
            const [suggestedLevel, setSuggestedLevel] = useState('None');
            const [finalLevel, setFinalLevel] = useState('None');
            const [bapNotes, setBapNotes] = useState('');
            
            // STATE FOR EDITING
            const [editingCase, setEditingCase] = useState(null);
            const [editPunishmentLevel, setEditPunishmentLevel] = useState('None');
            const [editEndDate, setEditEndDate] = useState('');
            const [editNotes, setEditNotes] = useState('');

            const [newViolation, setNewViolation] = useState('');
            
            // --- FILTERS ---
            const [filterLocation, setFilterLocation] = useState('');
            const [filterName, setFilterName] = useState('');
            const [filterRole, setFilterRole] = useState('');
            const [filterStatus, setFilterStatus] = useState('');

            const refreshData = () => {
                setLocations(db.getLocations());
                setViolations(db.getViolations());
                setAmts(db.getAMTs());
                setCases(db.getCases());
            };

            useEffect(() => { refreshData(); }, []);
            useEffect(() => { resetFilters(); }, [tab]);

            // Helper for Unique Names in Admin Filter
            const uniqueAmtNames = useMemo(() => {
                const names = cases.map(c => c.amtName);
                return [...new Set(names)].sort();
            }, [cases]);

            // Format Name Helper
            const formatAmtName = (name) => {
                return name.replace(/\s+/g, ' ').trim().toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
            };

            const handleBlockSubmit = (e) => {
                e.preventDefault();
                if (!newAmtName || !newAmtRole || !selectedLoc || !selectedVio) { 
                    Swal.fire({ icon: 'error', title: 'Data Tidak Lengkap', text: 'Mohon isi semua field yang tersedia.' });
                    return; 
                }
                
                const fixedName = formatAmtName(newAmtName);
                let amt = amts.find(a => a.name === fixedName && a.role === newAmtRole);
                if (!amt) { amt = db.addAMT(fixedName, newAmtRole, selectedLoc); } 
                db.createBlockCase(amt.id, selectedVio, blockDate);
                setNewAmtName(''); setSelectedVio('');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    text: `AMT ${fixedName} telah diblokir.`,
                    timer: 1500,
                    showConfirmButton: false
                });

                refreshData(); setTab('DASHBOARD');
            };

            const openUnblockModal = (c) => {
                const suggestion = db.suggestPunishment(c.amtId);
                setSelectedCase(c);
                setSuggestedLevel(suggestion);
                setFinalLevel(suggestion); 
                setUnblockDate(new Date().toISOString().split('T')[0]);
                setBapNotes('');
            };

            const handleUnblockSubmit = () => {
                if (!selectedCase) return;
                db.processUnblock(selectedCase.id, unblockDate, finalLevel, bapNotes);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Unblock Sukses',
                    text: 'Data BAP telah tersimpan.',
                    timer: 1500,
                    showConfirmButton: false
                });

                setSelectedCase(null); refreshData();
            };

            const openEditModal = (c) => {
                setEditingCase(c);
                setEditPunishmentLevel(c.punishmentLevel);
                if (c.punishmentEndDate === 'Permanent') { setEditEndDate(''); } else { setEditEndDate(c.punishmentEndDate || ''); }
                setEditNotes(c.notes || '');
            };

            const handleEditSubmit = () => {
                if(!editingCase) return;
                let finalEndDate = editEndDate;
                if(editPunishmentLevel === PunishmentLevel.PHK) { finalEndDate = 'Permanent'; }
                db.updateCase(editingCase.id, { punishmentLevel: editPunishmentLevel, punishmentEndDate: finalEndDate, notes: editNotes });
                
                Swal.fire({
                    icon: 'success',
                    title: 'Update Berhasil',
                    text: 'Data sanksi telah diperbarui.',
                    timer: 1500,
                    showConfirmButton: false
                });

                setEditingCase(null); refreshData();
            };

            const handleAddViolation = () => { if(newViolation) { db.addViolationType(newViolation); setNewViolation(''); refreshData(); } };
            
            const handleDeleteViolation = (id) => { 
                Swal.fire({
                    title: 'Apakah anda yakin?',
                    text: "Data akan dihapus permanen!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.deleteViolationType(id);
                        refreshData();
                        Swal.fire('Terhapus!', 'Data telah dihapus.', 'success');
                    }
                })
            };

            const resetFilters = () => { setFilterLocation(''); setFilterName(''); setFilterRole(''); setFilterStatus(''); };

            // Helper Filters
            const getFilteredCases = () => cases.filter(c => {
                // Flexible Location Search (Type or List)
                const matchLoc = filterLocation === '' || c.amtLocation.toLowerCase().includes(filterLocation.toLowerCase());
                
                // Name Filter (Standard Text Input)
                const matchName = filterName === '' || c.amtName.toLowerCase().includes(filterName.toLowerCase());

                const matchRole = filterRole === '' || c.amtRole === filterRole;
                const matchStatus = filterStatus === '' || c.status === filterStatus;
                return matchLoc && matchName && matchRole && matchStatus;
            });

            const getFilteredBlockedCases = () => cases.filter(c => {
                const isBlocked = c.status === 'BLOCKED';
                
                // Flexible Location Search
                const matchLoc = filterLocation === '' || c.amtLocation.toLowerCase().includes(filterLocation.toLowerCase());
                
                const matchName = filterName === '' || c.amtName.toLowerCase().includes(filterName.toLowerCase());
                const matchRole = filterRole === '' || c.amtRole === filterRole;
                return isBlocked && matchLoc && matchName && matchRole;
            });

            // Export Helpers
            const handleExportCSV = () => {
                const data = getFilteredCases();
                if (data.length === 0) { 
                    Swal.fire({icon: 'info', title: 'Data Kosong', text: 'Tidak ada data untuk diekspor.'}); 
                    return; 
                }
                const headers = ["No", "Nama AMT", "Jabatan", "Lokasi", "Jenis Pelanggaran", "Status", "Tanggal Blokir", "Tanggal Unblock", "Level Punishment", "Tanggal Berakhir Sanksi"];
                const csvRows = [headers.join(","), ...data.map((c, i) => [i+1, `"${c.amtName}"`, `"${c.amtRole}"`, `"${c.amtLocation}"`, `"${c.violationName}"`, c.status, c.blockDate, c.unblockDate||"-", c.punishmentLevel||"-", c.punishmentEndDate||"-"].join(","))];
                const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Tracing_List.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleExportBlockedCSV = () => {
                const data = getFilteredBlockedCases();
                if (data.length === 0) { 
                    Swal.fire({icon: 'info', title: 'Data Kosong', text: 'Tidak ada data blocked.'});
                    return; 
                }
                const headers = ["No", "Nama AMT", "Jabatan", "Lokasi", "Jenis Pelanggaran", "Tanggal Blokir", "Status"];
                const csvRows = [headers.join(","), ...data.map((c, i) => [i+1, `"${c.amtName}"`, `"${c.amtRole}"`, `"${c.amtLocation}"`, `"${c.violationName}"`, c.blockDate, "BLOCKED"].join(","))];
                const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Blocked_List.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const NavButton = ({ id, label }) => (
                <button onClick={() => setTab(id)} className={`w-full text-left px-4 py-3 rounded-lg mb-2 transition-all ${tab === id ? 'bg-blue-600 text-white font-bold shadow-md transform scale-105' : 'text-slate-300 hover:bg-slate-800'}`}>
                    {label}
                </button>
            );

            // Reusable Filter Bar Component for consistency
            const renderFilterBar = () => (
                <div className="grid grid-cols-1 md:grid-cols-5 gap-3 bg-white p-4 rounded-xl shadow-sm">
                    {/* 1. Filter Lokasi (Flexible Input + Datalist) */}
                    <div className="flex flex-col gap-1.5 relative">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">1. Lokasi</label>
                        <input 
                            list="adminLocationOptions" 
                            type="text" 
                            placeholder="Cari Lokasi / Pilih List..." 
                            value={filterLocation} 
                            onChange={(e) => setFilterLocation(e.target.value)} 
                            className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500 placeholder-slate-400" 
                        />
                        <datalist id="adminLocationOptions">
                            {locations.map(l => <option key={l.id} value={l.name} />)}
                        </datalist>
                    </div>

                    {/* 2. Filter Nama (STANDARD TEXT) */}
                    <div className="flex flex-col gap-1.5">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">2. Nama AMT</label>
                        <input type="text" placeholder="Cari Nama..." value={filterName} onChange={(e) => setFilterName(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>

                    {/* 3. Filter Jabatan */}
                    <div className="flex flex-col gap-1.5">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">3. Jabatan</label>
                        <select value={filterRole} onChange={(e) => setFilterRole(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Jabatan</option>
                            <option value="AMT 1">AMT 1</option>
                            <option value="AMT 2">AMT 2</option>
                        </select>
                    </div>

                    {/* 4. Filter Status */}
                    <div className="flex flex-col gap-1.5">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">4. Status</label>
                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Status</option>
                            <option value="BLOCKED">Blocked</option>
                            <option value="UNBLOCKED">Unblocked</option>
                        </select>
                    </div>

                    {/* Reset */}
                    <div>
                        <button onClick={resetFilters} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2.5 px-4 rounded-lg transition-colors text-sm flex items-center justify-center gap-2 border border-slate-300 h-[42px]">
                            Reset
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col md:flex-row min-h-[calc(100vh-64px)] animate-fade-in">
                    <aside className="w-full md:w-64 bg-slate-900 text-white p-6 flex-shrink-0">
                        <div className="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">Admin Menu</div>
                        <NavButton id="DASHBOARD" label="Dashboard" />
                        <NavButton id="DATA_VIEW" label="Data AMT" />
                        <NavButton id="BLOCK_ENTRY" label="Input Block" />
                        <NavButton id="UNBLOCK_PROCESS" label="Unblock Process" />
                        <NavButton id="MASTER_DATA" label="Master Data" />
                    </aside>
                    <div className="flex-1 p-8 bg-slate-50 overflow-y-auto h-[calc(100vh-64px)]">
                        {tab === 'DASHBOARD' && (
                             <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-slate-800">Admin Summary</h2>
                                <StatsCharts cases={cases} />
                             </div>
                        )}
                        
                        {tab === 'DATA_VIEW' && (
                             <div className="space-y-4">
                                <div className="flex justify-between items-center border-b pb-4">
                                    <h2 className="text-2xl font-bold">Data AMT</h2>
                                    <button onClick={handleExportCSV} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-emerald-700">Export CSV</button>
                                </div>
                                {renderFilterBar()}

                                <div className="bg-white rounded-xl shadow overflow-hidden">
                                    <div className="overflow-x-auto max-h-[600px]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-800 text-white sticky top-0">
                                                <tr>
                                                    <th className="p-4">Nama AMT</th>
                                                    <th className="p-4">Jabatan</th>
                                                    <th className="p-4">Lokasi</th>
                                                    <th className="p-4">Jenis Pelanggaran</th>
                                                    <th className="p-4">Status</th>
                                                    <th className="p-4">Punishment</th>
                                                    <th className="p-4 text-center">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getFilteredCases().map(c => (
                                                    <tr key={c.id} className="border-b hover:bg-slate-50">
                                                        <td className="p-4 font-bold text-slate-800">{c.amtName}</td>
                                                        <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${c.amtRole === 'AMT 1' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{c.amtRole}</span></td>
                                                        <td className="p-4">{c.amtLocation}</td>
                                                        <td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">{c.violationName}</span></td>
                                                        <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${c.status === 'BLOCKED' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{c.status}</span></td>
                                                        <td className="p-4">
                                                            {c.status === 'UNBLOCKED' ? (
                                                                <div className="flex flex-col"><span className="font-bold text-blue-700">{c.punishmentLevel}</span><span className="text-xs text-slate-500">Pemutihan: {formatDate(c.punishmentEndDate)}</span></div>
                                                            ) : <span className="text-slate-400 italic text-xs">Menunggu Proses</span>}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            {c.status === 'UNBLOCKED' && (
                                                                <button onClick={() => openEditModal(c)} className="text-amber-500 hover:text-amber-700 p-2 rounded hover:bg-amber-50"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                             </div>
                        )}

                        {/* EDIT MODAL */}
                        {editingCase && (
                             <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                                 <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl animate-fade-in">
                                     <h3 className="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2">Edit Punishment</h3>
                                     <div className="mb-4 text-sm text-slate-600 bg-slate-50 p-3 rounded">
                                         <p><strong>Nama:</strong> {editingCase.amtName}</p>
                                         <p><strong>Kasus:</strong> {editingCase.violationName}</p>
                                     </div>
                                     <label className="block text-xs font-bold mb-1 text-slate-500">LEVEL BARU</label>
                                     <select value={editPunishmentLevel} onChange={e => setEditPunishmentLevel(e.target.value)} className="border p-2 w-full rounded mb-3">{Object.values(PunishmentLevel).filter(l => l !== 'None').map(l => <option key={l} value={l}>{l}</option>)}</select>
                                     <label className="block text-xs font-bold mb-1 text-slate-500">TANGGAL BERAKHIR</label>
                                     <input type="date" value={editEndDate} onChange={e => setEditEndDate(e.target.value)} className="border p-2 w-full rounded mb-3" disabled={editPunishmentLevel === PunishmentLevel.PHK}/>
                                     {editPunishmentLevel === PunishmentLevel.PHK && <p className="text-xs text-red-500 mb-3 font-bold">* Permanent</p>}
                                     <label className="block text-xs font-bold mb-1 text-slate-500">NOTES</label>
                                     <textarea value={editNotes} onChange={e => setEditNotes(e.target.value)} className="border p-2 w-full rounded mb-6" rows="3"></textarea>
                                     <div className="flex gap-2">
                                         <button onClick={() => setEditingCase(null)} className="flex-1 bg-slate-200 py-3 rounded-lg font-bold">Batal</button>
                                         <button onClick={handleEditSubmit} className="flex-1 bg-amber-500 text-white py-3 rounded-lg font-bold shadow-lg">Simpan</button>
                                     </div>
                                 </div>
                             </div>
                        )}

                        {tab === 'BLOCK_ENTRY' && (
                            <div className="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg border-t-4 border-red-600 animate-scale-up">
                                <h2 className="text-2xl font-bold mb-6 text-red-700 flex items-center gap-2">
                                    Input Pelanggaran (Block)
                                </h2>
                                <form onSubmit={handleBlockSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500">NAMA AMT</label><input type="text" value={newAmtName} onChange={e => setNewAmtName(e.target.value)} className="border p-3 rounded-lg w-full mt-1 focus:ring-2 focus:ring-red-500" required /></div>
                                        <div><label className="text-xs font-bold text-slate-500">JABATAN</label><select value={newAmtRole} onChange={e => setNewAmtRole(e.target.value)} className="border p-3 rounded-lg w-full mt-1 font-bold" required><option value="AMT 1">AMT 1</option><option value="AMT 2">AMT 2</option></select></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500">LOKASI</label><select value={selectedLoc} onChange={e => setSelectedLoc(e.target.value)} className="border p-3 rounded-lg w-full mt-1" required><option value="">-- Pilih --</option>{locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select></div>
                                        <div><label className="text-xs font-bold text-slate-500">PELANGGARAN</label><select value={selectedVio} onChange={e => setSelectedVio(e.target.value)} className="border p-3 rounded-lg w-full mt-1" required><option value="">-- Pilih --</option>{violations.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}</select></div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-500">TANGGAL BLOCK</label><input type="date" value={blockDate} onChange={e => setBlockDate(e.target.value)} className="border p-3 rounded-lg w-full mt-1" required /></div>
                                    <button type="submit" className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 mt-4 shadow-lg">EXECUTE BLOCK</button>
                                </form>
                            </div>
                        )}

                        {tab === 'UNBLOCK_PROCESS' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b pb-4">
                                    <h2 className="text-2xl font-bold">Pending Unblocks</h2>
                                    <button onClick={handleExportBlockedCSV} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-emerald-700">Export CSV</button>
                                </div>
                                {renderFilterBar()}
                                
                                {getFilteredBlockedCases().length === 0 && <div className="text-slate-400 italic text-center py-10">No blocked AMTs pending.</div>}
                                {getFilteredBlockedCases().map(c => (
                                    <div key={c.id} className="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500 flex justify-between items-center">
                                        <div>
                                            <h3 className="font-bold text-lg">{c.amtName}</h3>
                                            <div className="flex items-center gap-2 mt-1">
                                                <span className={`px-2 py-0.5 rounded text-xs font-bold ${c.amtRole === 'AMT 1' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{c.amtRole}</span>
                                                <span className="text-sm text-red-600 font-medium">{c.violationName}</span>
                                            </div>
                                            <p className="text-xs text-slate-400 mt-1">Loc: {c.amtLocation} | Blocked: {c.blockDate}</p>
                                        </div>
                                        <button onClick={() => openUnblockModal(c)} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-blue-700">Process BAP</button>
                                    </div>
                                ))}

                                {selectedCase && (
                                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl animate-fade-in">
                                            <h3 className="text-xl font-bold mb-4 border-b pb-2">Process BAP: {selectedCase.amtName}</h3>
                                            
                                            <div className="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                                                <strong className="text-yellow-800 text-xs uppercase block">System Recommendation</strong>
                                                <span className="text-2xl font-bold text-yellow-700">{suggestedLevel}</span>
                                            </div>

                                            <label className="block text-xs font-bold mb-1 text-slate-500">PUNISHMENT LEVEL</label>
                                            <select value={finalLevel} onChange={e => setFinalLevel(e.target.value)} className="border p-2 w-full rounded mb-3">
                                                {Object.values(PunishmentLevel).filter(l => l !== 'None').map(l => <option key={l} value={l}>{l}</option>)}
                                            </select>
                                            
                                            <label className="block text-xs font-bold mb-1 text-slate-500">UNBLOCK DATE</label>
                                            <input type="date" value={unblockDate} onChange={e => setUnblockDate(e.target.value)} className="border p-2 w-full rounded mb-3" />
                                            
                                            <label className="block text-xs font-bold mb-1 text-slate-500">NOTES</label>
                                            <textarea value={bapNotes} onChange={e => setBapNotes(e.target.value)} className="border p-2 w-full rounded mb-6" rows="3"></textarea>
                                            
                                            <div className="flex gap-2">
                                                <button onClick={() => setSelectedCase(null)} className="flex-1 bg-slate-200 py-3 rounded-lg font-bold hover:bg-slate-300">Cancel</button>
                                                <button onClick={handleUnblockSubmit} className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg">Confirm</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {tab === 'MASTER_DATA' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-xl shadow border border-slate-100">
                                    <h3 className="font-bold mb-4 text-lg">Manage Violations</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input value={newViolation} onChange={e => setNewViolation(e.target.value)} className="border p-2 w-full rounded-lg text-sm" placeholder="New Violation Name" />
                                        <button onClick={handleAddViolation} className="bg-blue-600 text-white px-4 rounded-lg text-sm font-bold">Add</button>
                                    </div>
                                    <div className="max-h-60 overflow-y-auto space-y-1">
                                        {violations.map(v => (
                                            <div key={v.id} className="flex justify-between p-2 border-b text-sm items-center">
                                                {v.name}
                                                {v.isCustom && <button onClick={() => handleDeleteViolation(v.id)} className="text-red-500 font-bold px-2">Del</button>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 4. MAIN APP ROOT ---
        const App = () => {
            const [appState, setAppState] = useState('LANDING');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (username === 'EPN' && (password === '12345' || password === '12345.')) {
                    setAppState('ADMIN'); setLoginError('');
                } else { setLoginError('Invalid Credentials'); }
            };
            const handleLogout = () => { setAppState('LANDING'); setUsername(''); setPassword(''); };

            if (appState === 'LANDING') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 relative bg-cover bg-center bg-no-repeat bg-slate-900"
                        style={{ backgroundImage: "url('./background.jpg')" }}>
                        <div className="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
                        <div className="relative z-10 bg-white/95 rounded-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden max-w-5xl w-full min-h-[600px] border border-white/20">
                            <div className="w-full md:w-1/2 p-12 flex flex-col items-center justify-center text-center bg-slate-50/80 border-r border-slate-200">
                                <div className="h-24 w-auto mb-4">
                                    <img src="./logo.png" alt="Logo" className="h-full w-auto object-contain drop-shadow-md" onError={(e) => e.target.style.display = 'none'} />
                                    <div className="text-2xl font-bold text-slate-800 hidden peer-[:hidden]:block">elnusa <span className="text-red-600">petrofin</span></div>
                                </div>
                                <h1 className="text-3xl font-extrabold text-slate-900 mb-2">Sistem Monitoring AMT</h1>
                                <p className="text-slate-600 mb-10 font-medium">Monitoring Block & Unblock Awak Mobil Tangki</p>
                                <button onClick={() => setAppState('VIEW')} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl w-full max-w-xs shadow-lg transition-transform hover:-translate-y-1">Akses Monitoring View</button>
                            </div>
                            <div className="w-full md:w-1/2 p-12 flex flex-col justify-center bg-white">
                                <h2 className="text-2xl font-bold text-slate-900 mb-1">Login Administrator</h2>
                                <p className="text-sm text-slate-500 mb-8">Khusus untuk mengelola data & sanksi.</p>
                                <form onSubmit={handleLogin} className="space-y-6">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Username</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full border p-3 rounded-lg mt-1" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full border p-3 rounded-lg mt-1" /></div>
                                    {loginError && <div className="text-red-600 text-sm animate-shake">{loginError}</div>}
                                    <button type="submit" className="w-full bg-slate-900 text-white font-bold py-4 rounded-lg hover:bg-slate-800 shadow-xl transition-transform hover:-translate-y-1">Masuk Admin</button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50">
                    <header className="bg-white shadow-sm border-b sticky top-0 z-40 px-6 h-16 flex justify-between items-center">
                        <div className="flex items-center gap-3" onClick={() => setAppState('LANDING')}>
                            <img src="./logo.png" alt="Logo" className="h-8 w-auto" onError={(e) => e.target.style.display = 'none'} />
                            <span className="font-bold text-lg">MONITORING AMT</span>
                        </div>
                        {appState === 'ADMIN' ? (
                            <button onClick={handleLogout} className="text-red-600 font-bold text-sm">Logout</button>
                        ) : (
                            <button onClick={() => setAppState('LANDING')} className="text-slate-600 font-bold text-sm">Back Home</button>
                        )}
                    </header>
                    <main>
                        {appState === 'VIEW' && <ViewMode />}
                        {appState === 'ADMIN' && <AdminPanel />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>